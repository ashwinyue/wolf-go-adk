# è®¨è®ºé˜¶æ®µå¤šè½®å¯¹è¯è®¾è®¡æ–‡æ¡£

## 1. èƒŒæ™¯

å½“å‰ç‹¼äººæ€æ¸¸æˆçš„è®¨è®ºé˜¶æ®µé‡‡ç”¨**å•è½®å‘è¨€**æ¨¡å¼ï¼šæ¯ä¸ªç©å®¶æŒ‰é¡ºåºå‘è¨€ä¸€æ¬¡ï¼Œç„¶åç›´æ¥è¿›å…¥æŠ•ç¥¨é˜¶æ®µã€‚è¿™ç§æ¨¡å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### 1.1 å½“å‰æ¨¡å¼çš„å±€é™æ€§

| é—®é¢˜ | æè¿° |
|------|------|
| **ä¿¡æ¯ä¸å¯¹ç§°** | å…ˆå‘è¨€çš„ç©å®¶æ— æ³•å›åº”åå‘è¨€ç©å®¶çš„è´¨ç–‘ |
| **ç¼ºä¹äº’åŠ¨** | ç©å®¶ä¹‹é—´æ²¡æœ‰çœŸæ­£çš„"è®¨è®º"ï¼Œåªæ˜¯å•å‘é™ˆè¿° |
| **ç­–ç•¥å—é™** | æ— æ³•é€šè¿‡è¿½é—®ã€åé©³æ¥æ­éœ²ç‹¼äººç ´ç»½ |
| **æ¸¸æˆä½“éªŒ** | ä¸çœŸå®ç‹¼äººæ€æ¸¸æˆçš„è®¨è®ºæ°›å›´å·®è·è¾ƒå¤§ |

### 1.2 çœŸå®ç‹¼äººæ€çš„è®¨è®ºæ¨¡å¼

çœŸå®æ¸¸æˆä¸­ï¼Œè®¨è®ºé˜¶æ®µé€šå¸¸åŒ…å«ï¼š
- **é¦–è½®å‘è¨€**ï¼šæ¯äººé™ˆè¿°è§‚ç‚¹
- **è‡ªç”±è®¨è®º**ï¼šç©å®¶å¯ä»¥äº’ç›¸è´¨ç–‘ã€è¾©è®º
- **æ€»ç»“å‘è¨€**ï¼šæŠ•ç¥¨å‰çš„æœ€åé™ˆè¿°

## 2. å¤šè½®å¯¹è¯æ–¹æ¡ˆè®¾è®¡

### 2.1 æ–¹æ¡ˆæ¦‚è¿°

å¼•å…¥**å¤šè½®å¯¹è¯æœºåˆ¶**ï¼Œè®©è®¨è®ºé˜¶æ®µæ›´åŠ çœŸå®å’Œå®Œæ•´ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è®¨è®ºé˜¶æ®µæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸€è½®ï¼šé¡ºåºå‘è¨€ï¼ˆæ¯äººä¸€æ¬¡ï¼‰                                  â”‚
â”‚     â†“                                                        â”‚
â”‚  ç¬¬äºŒè½®ï¼šè‡ªç”±è®¨è®ºï¼ˆå¯é€‰æ‹©å‘è¨€æˆ–è·³è¿‡ï¼‰                          â”‚
â”‚     â†“                                                        â”‚
â”‚  ç¬¬ä¸‰è½®ï¼šæ€»ç»“é™ˆè¯ï¼ˆæ¯äººä¸€æ¬¡ï¼Œå¯é€‰ï¼‰                            â”‚
â”‚     â†“                                                        â”‚
â”‚  æŠ•ç¥¨é˜¶æ®µ                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†è®¾è®¡

#### 2.2.1 è®¨è®ºè½®æ¬¡é…ç½®

```go
type DiscussionConfig struct {
    // é¦–è½®å‘è¨€ï¼šå¿…é¡»ï¼Œæ¯äººä¸€æ¬¡
    FirstRoundRequired bool
    
    // è‡ªç”±è®¨è®ºè½®æ•°ï¼š0-3 è½®
    FreeDiscussionRounds int
    
    // æ€»ç»“é™ˆè¯ï¼šå¯é€‰
    SummaryRoundEnabled bool
    
    // æ¯è½®æœ€å¤§å‘è¨€äººæ•°ï¼ˆè‡ªç”±è®¨è®ºï¼‰
    MaxSpeakersPerRound int
    
    // å‘è¨€è¶…æ—¶æ—¶é—´
    SpeakTimeout time.Duration
}

// é»˜è®¤é…ç½®
var DefaultDiscussionConfig = DiscussionConfig{
    FirstRoundRequired:    true,
    FreeDiscussionRounds:  2,
    SummaryRoundEnabled:   false,
    MaxSpeakersPerRound:   5,
    SpeakTimeout:          30 * time.Second,
}
```

#### 2.2.2 è‡ªç”±è®¨è®ºæœºåˆ¶

åœ¨è‡ªç”±è®¨è®ºé˜¶æ®µï¼Œéœ€è¦è§£å†³**è°æ¥å‘è¨€**çš„é—®é¢˜ï¼š

**æ–¹æ¡ˆ Aï¼šä¸»æŒäººå†³å®šï¼ˆæ¨èï¼‰**
```go
// ä¸»æŒäººæ ¹æ®ä¸Šä¸‹æ–‡å†³å®šä¸‹ä¸€ä¸ªå‘è¨€è€…
func (m *ModeratorAgent) decideNextSpeaker(ctx context.Context, 
    alivePlayers []string, 
    lastSpeaker string,
    discussionHistory []Speech) string {
    
    prompt := fmt.Sprintf(`
å½“å‰è®¨è®ºå†å²ï¼š
%s

è¯·å†³å®šä¸‹ä¸€ä¸ªå‘è¨€è€…ï¼Œè€ƒè™‘ï¼š
1. è¢«è´¨ç–‘çš„ç©å®¶åº”è¯¥æœ‰æœºä¼šå›åº”
2. æ²‰é»˜çš„ç©å®¶å¯èƒ½éœ€è¦è¢«ç‚¹å
3. è®¨è®ºæ˜¯å¦å·²ç»å……åˆ†

è¾“å‡º JSONï¼š{"next_speaker": "PlayerX", "reason": "..."}
æˆ– {"end_discussion": true, "reason": "è®¨è®ºå·²å……åˆ†"}
`, formatHistory(discussionHistory))
    
    return m.callModeratorLLM(ctx, prompt)
}
```

**æ–¹æ¡ˆ Bï¼šç©å®¶è‡ªä¸»ç”³è¯·**
```go
// æ¯è½®è¯¢é—®æ‰€æœ‰ç©å®¶æ˜¯å¦æƒ³å‘è¨€
func (m *ModeratorAgent) collectSpeakRequests(ctx context.Context, 
    alivePlayers []string) []string {
    
    var wantToSpeak []string
    for _, player := range alivePlayers {
        response := m.callPlayer(ctx, player, 
            "æ˜¯å¦æƒ³è¦å‘è¨€ï¼Ÿå›å¤ 'æ˜¯' æˆ– 'å¦'")
        if strings.Contains(response, "æ˜¯") {
            wantToSpeak = append(wantToSpeak, player)
        }
    }
    return wantToSpeak
}
```

**æ–¹æ¡ˆ Cï¼šæ··åˆæ¨¡å¼ï¼ˆæœ€ä½³ï¼‰**
```go
// ç»“åˆä¸»æŒäººå¼•å¯¼å’Œç©å®¶æ„æ„¿
func (m *ModeratorAgent) freeDiscussionRound(ctx context.Context,
    gen *adk.AsyncGenerator[*adk.AgentEvent],
    alivePlayers []string,
    history []Speech) {
    
    // 1. ä¸»æŒäººåˆ†æè°åº”è¯¥å‘è¨€
    suggestions := m.analyzeSpeakingNeeds(ctx, history)
    
    // 2. è¯¢é—®è¢«å»ºè®®çš„ç©å®¶
    for _, player := range suggestions {
        prompt := fmt.Sprintf(
            "æœ‰ç©å®¶è´¨ç–‘äº†ä½ çš„è§‚ç‚¹ï¼Œä½ æ˜¯å¦æƒ³è¦å›åº”ï¼Ÿ")
        response := m.callPlayer(ctx, player, prompt)
        if response != "" && !isSkip(response) {
            m.broadcastSpeech(gen, player, response)
            history = append(history, Speech{Player: player, Content: response})
        }
    }
    
    // 3. è¯¢é—®å…¶ä»–ç©å®¶æ˜¯å¦æœ‰è¡¥å……
    for _, player := range alivePlayers {
        if !contains(suggestions, player) {
            prompt := "æ˜¯å¦æœ‰è¡¥å……å‘è¨€ï¼Ÿå›å¤å†…å®¹æˆ–'è·³è¿‡'"
            response := m.callPlayer(ctx, player, prompt)
            if response != "" && !isSkip(response) {
                m.broadcastSpeech(gen, player, response)
            }
        }
    }
}
```

#### 2.2.3 ä¸Šä¸‹æ–‡ç®¡ç†

å¤šè½®å¯¹è¯éœ€è¦æ›´å¥½çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼š

```go
type DiscussionContext struct {
    Round       int                    // å½“å‰è®¨è®ºè½®æ¬¡
    Speeches    []Speech               // æ‰€æœ‰å‘è¨€è®°å½•
    Accusations map[string][]string    // è´¨ç–‘å…³ç³»ï¼šè¢«è´¨ç–‘è€… -> è´¨ç–‘è€…åˆ—è¡¨
    KeyPoints   []string               // å…³é”®ä¿¡æ¯ç‚¹
}

type Speech struct {
    Player    string
    Content   string
    Round     int
    Timestamp time.Time
    ReplyTo   string  // å›å¤è°çš„å‘è¨€
}

// æ„å»ºç©å®¶çš„è®¨è®ºä¸Šä¸‹æ–‡
func (m *ModeratorAgent) buildDiscussionPrompt(
    player string, 
    ctx *DiscussionContext) string {
    
    var prompt strings.Builder
    
    // 1. ä¹‹å‰çš„å‘è¨€æ‘˜è¦
    prompt.WriteString("=== è®¨è®ºè®°å½• ===\n")
    for _, speech := range ctx.Speeches {
        prompt.WriteString(fmt.Sprintf("[%s]: %s\n", 
            speech.Player, speech.Content))
    }
    
    // 2. é’ˆå¯¹è¯¥ç©å®¶çš„è´¨ç–‘
    if accusations, ok := ctx.Accusations[player]; ok {
        prompt.WriteString(fmt.Sprintf(
            "\nâš ï¸ ä»¥ä¸‹ç©å®¶è´¨ç–‘äº†ä½ : %s\n", 
            strings.Join(accusations, ", ")))
    }
    
    // 3. æç¤º
    prompt.WriteString("\nè¯·å‘è¡¨ä½ çš„è§‚ç‚¹ï¼Œå¯ä»¥ï¼š\n")
    prompt.WriteString("- å›åº”å¯¹ä½ çš„è´¨ç–‘\n")
    prompt.WriteString("- è´¨ç–‘å…¶ä»–ç©å®¶\n")
    prompt.WriteString("- åˆ†æå±€åŠ¿\n")
    prompt.WriteString("- å›å¤'è·³è¿‡'æ”¾å¼ƒå‘è¨€\n")
    
    return prompt.String()
}
```

#### 2.2.4 è´¨ç–‘æ£€æµ‹

è‡ªåŠ¨æ£€æµ‹å‘è¨€ä¸­çš„è´¨ç–‘å…³ç³»ï¼š

```go
// åˆ†æå‘è¨€ä¸­çš„è´¨ç–‘
func (m *ModeratorAgent) detectAccusations(
    speaker string, 
    content string, 
    alivePlayers []string) []string {
    
    var accused []string
    
    // æ–¹æ³•1ï¼šå…³é”®è¯åŒ¹é…
    accusationKeywords := []string{
        "æ€€ç–‘", "å¯ç–‘", "ç‹¼äºº", "æœ‰é—®é¢˜", 
        "ä¸å¯¹åŠ²", "æ’’è°", "æŠ•ç¥¨æ·˜æ±°",
    }
    
    for _, player := range alivePlayers {
        if player == speaker {
            continue
        }
        // æ£€æŸ¥æ˜¯å¦æåˆ°è¯¥ç©å®¶ + è´¨ç–‘å…³é”®è¯
        if strings.Contains(content, player) {
            for _, kw := range accusationKeywords {
                if strings.Contains(content, kw) {
                    accused = append(accused, player)
                    break
                }
            }
        }
    }
    
    // æ–¹æ³•2ï¼šLLM åˆ†æï¼ˆæ›´å‡†ç¡®ï¼‰
    if len(accused) == 0 {
        accused = m.llmDetectAccusations(content, alivePlayers)
    }
    
    return accused
}
```

### 2.3 äººç±»ç©å®¶çš„å¤šè½®å¯¹è¯

å¯¹äºäººç±»ç©å®¶ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

```go
func (m *ModeratorAgent) humanFreeDiscussion(
    ctx context.Context,
    gen *adk.AsyncGenerator[*adk.AgentEvent],
    humanPlayer string,
    discussionCtx *DiscussionContext) {
    
    // æ˜¾ç¤ºå½“å‰è®¨è®ºçŠ¶æ€
    prompt := fmt.Sprintf(`
=== å½“å‰è®¨è®º ===
%s

ä½ å¯ä»¥ï¼š
1. è¾“å…¥å‘è¨€å†…å®¹
2. è¾“å…¥ '@PlayerX å†…å®¹' å›å¤ç‰¹å®šç©å®¶
3. è¾“å…¥ 'è·³è¿‡' æ”¾å¼ƒå‘è¨€
4. è¾“å…¥ 'æŠ•ç¥¨' ç»“æŸè®¨è®ºè¿›å…¥æŠ•ç¥¨
`, formatDiscussion(discussionCtx))
    
    response := m.callPlayer(ctx, humanPlayer, prompt)
    
    // è§£æäººç±»è¾“å…¥
    if strings.HasPrefix(response, "@") {
        // å›å¤ç‰¹å®šç©å®¶
        parts := strings.SplitN(response[1:], " ", 2)
        if len(parts) == 2 {
            replyTo := parts[0]
            content := parts[1]
            m.broadcastReply(gen, humanPlayer, replyTo, content)
        }
    } else if response == "æŠ•ç¥¨" {
        // äººç±»è¯·æ±‚ç»“æŸè®¨è®º
        m.endDiscussion = true
    } else if response != "è·³è¿‡" {
        m.broadcastSpeech(gen, humanPlayer, response)
    }
}
```

## 3. å®ç°æ­¥éª¤

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å¤šè½®

1. ä¿®æ”¹ `discussPhase` æ”¯æŒå¤šè½®å‘è¨€
2. æ·»åŠ  `DiscussionConfig` é…ç½®
3. å®ç°åŸºæœ¬çš„è½®æ¬¡æ§åˆ¶

```go
// agents/supervisor/day_phase.go

func (m *ModeratorAgent) discussPhase(ctx context.Context, 
    gen *adk.AsyncGenerator[*adk.AgentEvent], 
    alivePlayers []string) {
    
    config := DefaultDiscussionConfig
    discussionCtx := &DiscussionContext{}
    
    // ç¬¬ä¸€è½®ï¼šé¡ºåºå‘è¨€
    m.sendMessage(gen, "  ğŸ’¬ ç¬¬ä¸€è½®å‘è¨€:")
    speakingOrder := m.decideSpeakingOrder(ctx, alivePlayers)
    for _, player := range speakingOrder {
        response := m.callPlayer(ctx, player, 
            m.buildDiscussionPrompt(player, discussionCtx))
        if response != "" {
            discussionCtx.Speeches = append(discussionCtx.Speeches, 
                Speech{Player: player, Content: response, Round: 1})
            m.broadcastSpeech(gen, player, response)
            
            // æ£€æµ‹è´¨ç–‘
            accused := m.detectAccusations(player, response, alivePlayers)
            for _, a := range accused {
                discussionCtx.Accusations[a] = append(
                    discussionCtx.Accusations[a], player)
            }
        }
    }
    
    // è‡ªç”±è®¨è®ºè½®æ¬¡
    for round := 0; round < config.FreeDiscussionRounds; round++ {
        m.sendMessage(gen, fmt.Sprintf("  ğŸ’¬ è‡ªç”±è®¨è®º (ç¬¬ %d è½®):", round+1))
        
        if !m.freeDiscussionRound(ctx, gen, alivePlayers, discussionCtx) {
            break // è®¨è®ºå·²å……åˆ†ï¼Œæå‰ç»“æŸ
        }
    }
}
```

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šæ™ºèƒ½å¼•å¯¼

1. å®ç°ä¸»æŒäººæ™ºèƒ½å†³å®šå‘è¨€è€…
2. æ·»åŠ è´¨ç–‘æ£€æµ‹
3. ä¼˜åŒ–ä¸Šä¸‹æ–‡æç¤º

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šäººç±»äº¤äº’ä¼˜åŒ–

1. æ”¹è¿›äººç±»ç©å®¶çš„äº¤äº’ç•Œé¢
2. æ”¯æŒ `@` å›å¤è¯­æ³•
3. æ”¯æŒäººç±»ä¸»åŠ¨ç»“æŸè®¨è®º

## 4. é…ç½®é€‰é¡¹

```go
// params/game.go

type GameConfig struct {
    // ... å…¶ä»–é…ç½®
    
    // è®¨è®ºé…ç½®
    Discussion DiscussionConfig
}

// ç¯å¢ƒå˜é‡æ”¯æŒ
// DISCUSSION_FREE_ROUNDS=2
// DISCUSSION_SUMMARY=true
```

## 5. é¢„æœŸæ•ˆæœ

### 5.1 æ¸¸æˆä½“éªŒæå‡

| æ–¹é¢ | å•è½®æ¨¡å¼ | å¤šè½®æ¨¡å¼ |
|------|----------|----------|
| äº’åŠ¨æ€§ | â­ | â­â­â­â­ |
| ç­–ç•¥æ·±åº¦ | â­â­ | â­â­â­â­ |
| çœŸå®æ„Ÿ | â­â­ | â­â­â­â­â­ |
| æ¸¸æˆæ—¶é•¿ | çŸ­ | ä¸­ç­‰ |
| Token æ¶ˆè€— | ä½ | ä¸­é«˜ |

### 5.2 ç¤ºä¾‹å¯¹è¯

```
=== ç¬¬ä¸€è½®å‘è¨€ ===
[Player1]: æ˜¨æ™šå¹³å®‰å¤œï¼Œæˆ‘è®¤ä¸ºæˆ‘ä»¬åº”è¯¥å…³æ³¨å‘è¨€å†…å®¹...
[Player2]: æˆ‘åŒæ„ Player1 çš„è§‚ç‚¹ï¼Œä½†æˆ‘æ³¨æ„åˆ° Player5 ä¸€ç›´å¾ˆæ²‰é»˜...
[Player3]: Player2 ä½ ä¸ºä»€ä¹ˆè¦é’ˆå¯¹ Player5ï¼Ÿä½ æ˜¯ä¸æ˜¯æƒ³è½¬ç§»æ³¨æ„åŠ›ï¼Ÿ

=== è‡ªç”±è®¨è®º (ç¬¬ 1 è½®) ===
[Player2]: æˆ‘åªæ˜¯æå‡ºç–‘é—®ï¼ŒPlayer3 ä½ ååº”è¿™ä¹ˆå¤§æ˜¯ä¸æ˜¯å¿ƒè™šï¼Ÿ
[Player5]: æˆ‘æ¥å›åº”ä¸€ä¸‹ï¼Œæˆ‘ä¹‹å‰æ²‰é»˜æ˜¯å› ä¸ºåœ¨è§‚å¯Ÿ...
[Player3]: æˆ‘æ²¡æœ‰å¿ƒè™šï¼Œæˆ‘åªæ˜¯è§‰å¾— Player2 çš„é€»è¾‘æœ‰é—®é¢˜

=== è‡ªç”±è®¨è®º (ç¬¬ 2 è½®) ===
[ä¸»æŒäºº]: è®¨è®ºå·²å……åˆ†ï¼Œè¿›å…¥æŠ•ç¥¨é˜¶æ®µ
```

## 6. é£é™©ä¸å¯¹ç­–

| é£é™© | å¯¹ç­– |
|------|------|
| è®¨è®ºè¿‡é•¿ | è®¾ç½®æœ€å¤§è½®æ¬¡å’Œè¶…æ—¶ |
| Token æ¶ˆè€—é«˜ | å‹ç¼©å†å²ä¸Šä¸‹æ–‡ |
| æ­»å¾ªç¯äº‰è®º | ä¸»æŒäººå¼ºåˆ¶ç»“æŸ |
| äººç±»ç­‰å¾…è¿‡ä¹… | å¹¶è¡Œå¤„ç† AI å‘è¨€ |

## 7. æ€»ç»“

å¼•å…¥å¤šè½®å¯¹è¯æœºåˆ¶å¯ä»¥æ˜¾è‘—æå‡ç‹¼äººæ€æ¸¸æˆçš„çœŸå®æ„Ÿå’Œç­–ç•¥æ·±åº¦ã€‚å»ºè®®é‡‡ç”¨**æ··åˆæ¨¡å¼**ï¼ˆä¸»æŒäººå¼•å¯¼ + ç©å®¶æ„æ„¿ï¼‰ï¼Œåˆ†é˜¶æ®µå®ç°ï¼Œä¼˜å…ˆä¿è¯æ¸¸æˆæµç•…æ€§ã€‚

### æ¨èé…ç½®

- **å¿«é€Ÿæ¨¡å¼**ï¼š1 è½®é¦–å‘ + 1 è½®è‡ªç”±è®¨è®º
- **æ ‡å‡†æ¨¡å¼**ï¼š1 è½®é¦–å‘ + 2 è½®è‡ªç”±è®¨è®º
- **æ·±åº¦æ¨¡å¼**ï¼š1 è½®é¦–å‘ + 3 è½®è‡ªç”±è®¨è®º + æ€»ç»“é™ˆè¯
