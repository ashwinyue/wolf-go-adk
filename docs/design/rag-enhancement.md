# RAG å¢å¼ºè®¾è®¡æ–‡æ¡£

## 1. å½“å‰å®ç°åˆ†æ

### 1.1 å·²å®ç°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰ RAG æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¸¸æˆäº‹ä»¶ â†’ Episode â†’ Milvus (å‘é‡å­˜å‚¨)                       â”‚
â”‚                          â†“                                   â”‚
â”‚  æ£€ç´¢æŸ¥è¯¢ â†’ Ark Embedding â†’ å‘é‡æ£€ç´¢ â†’ ç›¸å…³è®°å¿†               â”‚
â”‚                          â†“                                   â”‚
â”‚  åŸºç¡€ Prompt + ç›¸å…³è®°å¿† â†’ å¢å¼º Prompt â†’ Agent å†³ç­–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å­˜å‚¨çš„äº‹ä»¶ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `speech` | ç©å®¶å‘è¨€ | åˆ†æå‘è¨€é€»è¾‘ã€å¯»æ‰¾çŸ›ç›¾ |
| `vote` | æŠ•ç¥¨è®°å½• | è¿½è¸ªæŠ•ç¥¨å€¾å‘ |
| `kill` | ç‹¼äººå‡»æ€ | å¤œé—´è¡ŒåŠ¨è®°å½• |
| `save` | å¥³å·«æ•‘äºº | æŠ€èƒ½ä½¿ç”¨è®°å½• |
| `poison` | å¥³å·«æ¯’äºº | æŠ€èƒ½ä½¿ç”¨è®°å½• |
| `check` | é¢„è¨€å®¶æŸ¥éªŒ | èº«ä»½ä¿¡æ¯ï¼ˆä»…é¢„è¨€å®¶å¯è§ï¼‰ |
| `death` | ç©å®¶æ­»äº¡ | æ­»äº¡ä¿¡æ¯ |
| `last_words` | é—è¨€ | æ­»å‰ä¿¡æ¯ |
| `hunter_shoot` | çŒäººå¼€æª | çŒäººè¡ŒåŠ¨ |

## 2. ç¼ºå¤±åŠŸèƒ½åˆ†æ

### 2.1 æƒ…æ™¯è®°å¿† vs è¯­ä¹‰è®°å¿†

**å½“å‰é—®é¢˜**ï¼šåªæœ‰è¯­ä¹‰è®°å¿†ï¼ˆå‘é‡æ£€ç´¢ï¼‰ï¼Œç¼ºå°‘çŸ­æœŸæƒ…æ™¯è®°å¿†

```
æƒ…æ™¯è®°å¿†ï¼ˆEpisodic Memoryï¼‰ï¼š
- æœ€è¿‘ N è½®çš„å®Œæ•´äº‹ä»¶åºåˆ—
- æŒ‰æ—¶é—´é¡ºåºç»„ç»‡
- ç”¨äºç†è§£"åˆšåˆšå‘ç”Ÿäº†ä»€ä¹ˆ"

è¯­ä¹‰è®°å¿†ï¼ˆSemantic Memoryï¼‰ï¼š
- å‘é‡åŒ–çš„å†å²ä¿¡æ¯
- æŒ‰ç›¸å…³æ€§æ£€ç´¢
- ç”¨äº"è¿™ä¸ªäººä¹‹å‰è¯´è¿‡ä»€ä¹ˆ"
```

**å»ºè®®å®ç°**ï¼š

```go
// memory/short_term.go

type ShortTermMemory struct {
    mu       sync.RWMutex
    episodes []*Episode
    maxSize  int
}

func NewShortTermMemory(maxSize int) *ShortTermMemory {
    return &ShortTermMemory{
        episodes: make([]*Episode, 0),
        maxSize:  maxSize,
    }
}

func (m *ShortTermMemory) Add(ep *Episode) {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    m.episodes = append(m.episodes, ep)
    if len(m.episodes) > m.maxSize {
        m.episodes = m.episodes[1:]
    }
}

func (m *ShortTermMemory) GetRecent(n int) []*Episode {
    m.mu.RLock()
    defer m.mu.RUnlock()
    
    if n > len(m.episodes) {
        n = len(m.episodes)
    }
    return m.episodes[len(m.episodes)-n:]
}

func (m *ShortTermMemory) GetByRound(round int) []*Episode {
    m.mu.RLock()
    defer m.mu.RUnlock()
    
    var result []*Episode
    for _, ep := range m.episodes {
        if ep.Round == round {
            result = append(result, ep)
        }
    }
    return result
}
```

### 2.2 æ€€ç–‘å…³ç³»è¿½è¸ª

**å½“å‰é—®é¢˜**ï¼š`EpisodeAccusation` å·²å®šä¹‰ä½†æœªä½¿ç”¨

**å»ºè®®å®ç°**ï¼š

```go
// åœ¨å‘è¨€å¤„ç†ä¸­æ£€æµ‹æ€€ç–‘å…³ç³»
func detectAccusations(speaker, content string, players []string) []string {
    keywords := []string{"æ€€ç–‘", "å¯ç–‘", "ç‹¼äºº", "æœ‰é—®é¢˜", "æŠ•ç¥¨"}
    var accused []string
    
    for _, player := range players {
        if player == speaker {
            continue
        }
        if strings.Contains(content, player) {
            for _, kw := range keywords {
                if strings.Contains(content, kw) {
                    accused = append(accused, player)
                    break
                }
            }
        }
    }
    return accused
}

// å­˜å‚¨æ€€ç–‘å…³ç³»
for _, target := range detectAccusations(speaker, response, alivePlayers) {
    m.storeEpisodeToRAG(ctx, memory.EpisodeAccusation, speaker, target,
        fmt.Sprintf("%s æ€€ç–‘ %s", speaker, target))
}
```

### 2.3 æˆæœ¬é‡åŒ–è¯„ä¼°

**å½“å‰é—®é¢˜**ï¼šæ—  API è°ƒç”¨å’Œ Token ç»Ÿè®¡

**å»ºè®®å®ç°**ï¼š

```go
// memory/metrics.go

type RAGMetrics struct {
    mu sync.Mutex
    
    // Embedding è°ƒç”¨
    EmbeddingCalls   int64
    EmbeddingTokens  int64
    EmbeddingLatency time.Duration
    
    // æ£€ç´¢è°ƒç”¨
    RetrieveCalls    int64
    RetrieveLatency  time.Duration
    
    // å­˜å‚¨è°ƒç”¨
    StoreCalls       int64
    StoreLatency     time.Duration
    
    // æˆæœ¬ä¼°ç®—ï¼ˆæŒ‰ Ark å®šä»·ï¼‰
    EstimatedCostUSD float64
}

func (m *RAGMetrics) RecordEmbedding(tokens int, latency time.Duration) {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    m.EmbeddingCalls++
    m.EmbeddingTokens += int64(tokens)
    m.EmbeddingLatency += latency
    
    // Ark embedding å®šä»·ï¼šçº¦ 0.0001 USD / 1K tokens
    m.EstimatedCostUSD += float64(tokens) * 0.0001 / 1000
}

func (m *RAGMetrics) Report() string {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    return fmt.Sprintf(`
RAG ä½¿ç”¨ç»Ÿè®¡ï¼š
- Embedding è°ƒç”¨: %d æ¬¡
- Embedding Tokens: %d
- æ£€ç´¢è°ƒç”¨: %d æ¬¡
- å­˜å‚¨è°ƒç”¨: %d æ¬¡
- é¢„ä¼°æˆæœ¬: $%.4f
`, m.EmbeddingCalls, m.EmbeddingTokens, 
   m.RetrieveCalls, m.StoreCalls, m.EstimatedCostUSD)
}
```

## 3. RAG åœ¨ Agent å†³ç­–é“¾ä¸­çš„ä½œç”¨

### 3.1 å½“å‰å†³ç­–é“¾

```
ç”¨æˆ·è¾“å…¥ â†’ åŸºç¡€ Prompt â†’ Agent â†’ å“åº”
```

### 3.2 RAG å¢å¼ºå†³ç­–é“¾

```
ç”¨æˆ·è¾“å…¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ„å»ºæ£€ç´¢æŸ¥è¯¢                         â”‚
â”‚    - ç©å®¶å + é˜¶æ®µå…³é”®è¯                â”‚
â”‚    - BuildQueryFromContext()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯­ä¹‰è®°å¿†æ£€ç´¢                         â”‚
â”‚    - Milvus å‘é‡æ£€ç´¢                   â”‚
â”‚    - TopK = 10                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æƒ…æ™¯è®°å¿†è·å–ï¼ˆå»ºè®®æ·»åŠ ï¼‰              â”‚
â”‚    - æœ€è¿‘ N è½®äº‹ä»¶                     â”‚
â”‚    - å½“å‰è½®æ¬¡å®Œæ•´è®°å½•                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Prompt å¢å¼º                         â”‚
â”‚    - å…³é”®äº‹ä»¶ä¼˜å…ˆ                       â”‚
â”‚    - æŠ•ç¥¨è®°å½•                          â”‚
â”‚    - ç›¸å…³å‘è¨€                          â”‚
â”‚    - BuildAugmentedPrompt()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å¢å¼º Prompt â†’ Agent â†’ å“åº”
```

### 3.3 RAG å¯¹å†³ç­–çš„å½±å“ç¤ºä¾‹

**åœºæ™¯**ï¼šPlayer3 éœ€è¦å‘è¨€ï¼ŒPlayer1 ä¹‹å‰è¯´è¿‡æ€€ç–‘ Player5

**æ—  RAG**ï¼š
```
Prompt: "è½®åˆ°ä½ å‘è¨€äº†ï¼Œè¯·åˆ†æå±€åŠ¿"
å“åº”: "æˆ‘è§‰å¾—å¤§å®¶éƒ½æŒºæ­£å¸¸çš„..."ï¼ˆç¼ºä¹ä¿¡æ¯ï¼‰
```

**æœ‰ RAG**ï¼š
```
Prompt: 
"## ğŸ“š ç›¸å…³å†å²è®°å¿†
### ğŸ”‘ å…³é”®äº‹ä»¶
- ğŸ’€ [Player7] æ­»äº¡
### ğŸ’¬ ç›¸å…³å‘è¨€
- ğŸ’¬ [Player1] å‘è¨€: "æˆ‘æ€€ç–‘ Player5ï¼Œä»–çš„å‘è¨€é€»è¾‘æœ‰é—®é¢˜"
---
è½®åˆ°ä½ å‘è¨€äº†ï¼Œè¯·åˆ†æå±€åŠ¿"

å“åº”: "æˆ‘æ³¨æ„åˆ° Player1 æ€€ç–‘ Player5ï¼Œä½†æˆ‘è§‰å¾—..."ï¼ˆæœ‰é’ˆå¯¹æ€§ï¼‰
```

## 4. ä¼ä¸šçº§æˆæœ¬é‡åŒ–

### 4.1 å•å±€æ¸¸æˆæˆæœ¬ä¼°ç®—

| ç»„ä»¶ | è°ƒç”¨æ¬¡æ•° | Token ä¼°ç®— | æˆæœ¬ |
|------|----------|------------|------|
| Embedding (å­˜å‚¨) | ~50 æ¬¡ | ~5000 tokens | ~$0.0005 |
| Embedding (æ£€ç´¢) | ~30 æ¬¡ | ~3000 tokens | ~$0.0003 |
| LLM è°ƒç”¨ | ~100 æ¬¡ | ~50000 tokens | ~$0.05 |
| **æ€»è®¡** | | | **~$0.05/å±€** |

### 4.2 ç›‘æ§æŒ‡æ ‡å»ºè®®

```go
type GameMetrics struct {
    // RAG æŒ‡æ ‡
    RAGMetrics *RAGMetrics
    
    // LLM æŒ‡æ ‡
    LLMCalls        int64
    LLMInputTokens  int64
    LLMOutputTokens int64
    
    // æ¸¸æˆæŒ‡æ ‡
    GameDuration    time.Duration
    TotalRounds     int
    
    // è´¨é‡æŒ‡æ ‡
    RAGHitRate      float64  // RAG æ£€ç´¢å‘½ä¸­ç‡
    DecisionQuality float64  // å†³ç­–è´¨é‡è¯„åˆ†
}
```

## 5. å®ç°ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å·¥ä½œé‡ | ä»·å€¼ |
|--------|------|--------|------|
| P0 | æ€€ç–‘å…³ç³»æ£€æµ‹å­˜å‚¨ | å° | é«˜ |
| P1 | çŸ­æœŸæƒ…æ™¯è®°å¿† | ä¸­ | é«˜ |
| P2 | æˆæœ¬ç»Ÿè®¡ | å° | ä¸­ |
| P3 | è´¨é‡è¯„ä¼°æŒ‡æ ‡ | å¤§ | ä¸­ |

## 6. æ€»ç»“

å½“å‰ RAG å®ç°**åŸºæœ¬ç¬¦åˆè¦æ±‚**ï¼Œä½†å¯ä»¥æ”¹è¿›ï¼š

### å·²æ»¡è¶³
- âœ… è·¨è½®æ¬¡è®°å¿†å­˜å‚¨
- âœ… å‘é‡æ•°æ®åº“è¯­ä¹‰å¬å›
- âœ… å‘è¨€é˜¶æ®µæ£€ç´¢å†å²
- âœ… RAG å¢å¼º Prompt

### å»ºè®®æ”¹è¿›
- âš ï¸ æ·»åŠ çŸ­æœŸæƒ…æ™¯è®°å¿†ï¼ˆè¡¥å……è¯­ä¹‰è®°å¿†ï¼‰
- âš ï¸ å¯ç”¨æ€€ç–‘å…³ç³»è¿½è¸ª
- âš ï¸ æ·»åŠ æˆæœ¬ç»Ÿè®¡
- âš ï¸ æ·»åŠ é—è¨€/çŒäººå¼€æªæ ¼å¼åŒ–ï¼ˆå·²ä¿®å¤ï¼‰
